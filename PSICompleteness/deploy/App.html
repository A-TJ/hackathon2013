<!DOCTYPE html>
<html>
<head>
    <title>PSI Completeness Report</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Yahoo.app.FeatureCompletenessCalculator",{prepareChartData:function(store){var categories=[],actualData=[],expectedData=[],forecastData=[],boundaryData=[];return store.each(function(record){var featureName=record.get("Name");categories.push(featureName);var startDate,endDate,Rst,Rend,featurePlanEstimate,featureActualEstimate;"HierarchicalRequirement"===record.self.typeName?(startDate=Rally.util.DateTime.fromIsoString(record.get("Iteration").StartDate),endDate=Rally.util.DateTime.fromIsoString(record.get("Iteration").EndDate),Rst=startDate,Rend=endDate,featurePlanEstimate=record.get("PlanEstimate"),featureActualEstimate="Accepted"!==record.get("ScheduleState")?0:featurePlanEstimate):(startDate=record.get("PlannedStartDate"),endDate=record.get("PlannedEndDate"),Rst=Rally.util.DateTime.fromIsoString(record.get("Release").ReleaseStartDate),Rend=Rally.util.DateTime.fromIsoString(record.get("Release").ReleaseDate),null===startDate&&(startDate=Rst),null===endDate&&(endDate=Rend),featurePlanEstimate=record.get("LeafStoryPlanEstimateTotal"),featureActualEstimate=record.get("AcceptedLeafStoryPlanEstimateTotal"));var featureLengthInDays=Math.ceil(Rally.util.DateTime.getDifference(endDate,startDate,"hour")/24),todayDate=new Date,featureNbDaysElapseToDate;featureNbDaysElapseToDate=todayDate>endDate?featureLengthInDays:startDate>todayDate?0:Rally.util.DateTime.getDifference(todayDate,startDate,"day");var featurePlanEstimatePerDay=featurePlanEstimate/featureLengthInDays,featureActualEstimatePerDay=featureActualEstimate/featureLengthInDays,plan=[],actual=[],forecast=[],boundary=[],nbDaysFromOrigin=Rally.util.DateTime.getDifference(startDate,Rst,"day"),Fst=nbDaysFromOrigin,Fend=nbDaysFromOrigin+featureLengthInDays,Est=nbDaysFromOrigin,FExpectedNbDays=Fst,Eend=Fst;featurePlanEstimate&&(FExpectedNbDays=featureNbDaysElapseToDate*featurePlanEstimatePerDay/featurePlanEstimate,Eend=nbDaysFromOrigin+FExpectedNbDays*featureLengthInDays);var Ast=nbDaysFromOrigin,FActualNbDays=Fst,Aend=Fst;featurePlanEstimate&&(FActualNbDays=featureActualEstimate/featurePlanEstimate,Aend=nbDaysFromOrigin+FActualNbDays*featureLengthInDays),boundary=[Fst,Fend],plan=[Est,Eend],actual=[Ast,Aend],featurePlanEstimate&&(forecast=100*((featurePlanEstimate-featureActualEstimate)/featureActualEstimatePerDay)+actual),actualData.push(actual),expectedData.push(plan),forecastData.push(forecast),boundaryData.push(boundary)}),{categories:categories,series:[{name:"Feature Actual",data:actualData},{name:"Feature Expected",data:expectedData},{name:"Feature Boundaries",data:boundaryData}]}}});
                Ext.define("Yahoo.app.PSIBurnUpCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",getMetrics:function(){return[{field:"PlanEstimate",as:"Planned",display:"line",f:"sum"},{field:"PlanEstimate",as:"Accepted",f:"filteredSum",filterField:"ScheduleState",filterValues:["Accepted","Released"],display:"column"}]}});
                Ext.define("Yahoo.app.FeaturePopover",{extend:"Rally.ui.popover.Popover",cls:"feature-popover",placement:"top",config:{record:void 0},initComponent:function(){this.callParent(arguments),this.add({xtype:"component",tpl:Ext.create("Ext.XTemplate","<tpl><div>Release Start Date: {[Rally.util.DateTime.fromIsoString(values.Release.ReleaseStartDate)]}</div></tpl>",{}),data:this.getRecord().data})}});
                Ext.define("Yahoo.app.FeatureCompleteness",{extend:"Rally.app.TimeboxScopedApp",requires:["Yahoo.app.FeatureCompletenessCalculator","Yahoo.app.PSIBurnUpCalculator","Yahoo.app.FeaturePopover"],componentCls:"app",scopeType:"release",addContent:function(scope){this._getFeaturesForCurrentRelease(scope),this._drawPSICompletenessChart()},onScopeChange:function(scope){this._getFeaturesForCurrentRelease(scope),this._drawPSICompletenessChart()},_getFeaturesForCurrentRelease:function(scope){Ext.create("Rally.data.WsapiDataStore",{model:"PortfolioItem/FEATURE",autoLoad:!0,fetch:!1,filters:[scope.getQueryFilter()],listeners:{load:function(store,data,success){var featureOIDList=[];store.each(function(record){featureOIDList.push(Rally.util.Ref.getOidFromRef(record.get("_ref")))}),this._drawPSIBurnUpChart(featureOIDList)},scope:this}})},_drawPSICompletenessChart:function(){this.chart&&this.chart.destroy(),this.chart=this.add({xtype:"rallychart",_haveDataToRender:function(){return!0},storeType:"Rally.data.WsapiDataStore",storeConfig:{model:"PortfolioItemFeature",context:this.getContext().getDataContext(),filters:[this.getContext().getTimeboxScope().getQueryFilter()],sorters:[{property:"Rank",direction:"DSC"}],pageSize:2,fetch:["PlannedStartDate","PlannedEndDate","LeafStoryPlanEstimateTotal","AcceptedLeafStoryPlanEstimateTotal","Name","Release","ReleaseDate","ReleaseStartDate"]},calculatorType:"Yahoo.app.FeatureCompletenessCalculator",calculatorConfig:{},chartConfig:this._getPSICompletenessChartConfig()})},_getPSICompletenessChartConfig:function(){var me=this;return{chart:{type:"columnrange",inverted:!0},title:{text:"PSI Completeness Report"},xAxis:{title:{text:null}},yAxis:{min:0,plotLines:[{value:function(){var todayDate=new Date,releaseStart=me.getContext().getTimeboxScope().getRecord().get("ReleaseStartDate"),releaseEnd=me.getContext().getTimeboxScope().getRecord().get("ReleaseDate");return releaseEnd>=todayDate&&todayDate>=releaseStart?Rally.util.DateTime.getDifference(todayDate,releaseStart,"day"):void 0}(),width:2,color:"red",zIndex:100}],endOnTick:!0,startOnTick:!0,tickInterval:7,title:{text:null},labels:{overflow:"justify",formatter:function(){var displayDate=Rally.util.DateTime.add(me.getContext().getTimeboxScope().getRecord().get("ReleaseStartDate"),"day",this.value);return Rally.util.DateTime.format(displayDate,"m/d/Y")}}},tooltip:{formatter:function(){var displayDateForLeftValue=Rally.util.DateTime.add(me.getContext().getTimeboxScope().getRecord().get("ReleaseStartDate"),"day",this.point.low),leftSide=Rally.util.DateTime.format(displayDateForLeftValue,"m/d/Y"),displayDateForRightValue=Rally.util.DateTime.add(me.getContext().getTimeboxScope().getRecord().get("ReleaseStartDate"),"day",this.point.high),rightSide=Rally.util.DateTime.format(displayDateForRightValue,"m/d/Y");return"<b>"+this.x+"</b><br />"+this.point.series.name+"<br />"+"Range date: "+leftSide+" - "+rightSide}},plotOptions:{columnrange:{dataLabels:{enabled:!1},events:{click:Ext.bind(function(e){var feature=e.point.series.data[0].record;feature&&this._showFeaturePopover(feature,Ext.get(e.target))},this)},cursor:"pointer"}},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:-100,y:100,floating:!0,borderWidth:1,backgroundColor:"#FFFFFF",shadow:!0,reversed:!0}}},_drawPSIBurnUpChart:function(featureOIDList){this.psiBurnUpchart&&this.psiBurnUpchart.destroy(),this.psiBurnUpchart=this.add({xtype:"rallychart",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:{find:{_TypeHierarchy:"HierarchicalRequirement",_ItemHierarchy:{$in:featureOIDList},Children:null,_ValidFrom:{$gte:Rally.util.DateTime.toIsoString(this.getContext().getTimeboxScope().getRecord().get("ReleaseStartDate"))}},fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState"]},calculatorType:"Yahoo.app.PSIBurnUpCalculator",calculatorConfig:{},chartConfig:this._getPSIBurnUpConfig()})},_getPSIBurnUpConfig:function(){return{chart:{type:"column"},title:{text:"PSI Tracking Burnup Chart"},xAxis:{tickInterval:7},yAxis:{min:0,title:{text:"Stories (points)"}}}},_showFeaturePopover:function(feature,el){Ext.create("Yahoo.app.FeaturePopover",{record:feature,target:el})}});

            Rally.launchApp('Yahoo.app.FeatureCompleteness', {
                name:"PSI Completeness Report",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
