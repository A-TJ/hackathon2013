<!DOCTYPE html>
<html>
<head>
    <title>Feature Completeness Report</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Yahoo.app.FeatureCompletenessCalculator",{prepareChartData:function(store){var categories=[],actualData=[],expectedData=[],forecastData=[];return store.each(function(record){categories.push(record.get("Name"));var startDate=record.get("PlannedStartDate"),endDate=record.get("PlannedEndDate");null===startDate&&(startDate=Rally.util.DateTime.fromIsoString(record.get("Release").ReleaseStartDate)),null===endDate&&(endDate=Rally.util.DateTime.fromIsoString(record.get("Release").ReleaseDate));var featureLengthInDays=Rally.util.DateTime.getDifference(endDate,startDate,"day"),todayDate=new Date,featureNbDaysElapseToDate=Rally.util.DateTime.getDifference(todayDate,startDate,"day");startDate>todayDate&&(featureNbDaysElapseToDate=0);var featurePlanEstimate=record.get("LeafStoryPlanEstimateTotal"),featureActualEstimate=record.get("AcceptedLeafStoryPlanEstimateTotal"),featurePlanEstimatePerDay=featurePlanEstimate/featureLengthInDays,featureActualEstimatePerDay=featureActualEstimate/featureLengthInDays,plan=0,actual=0,forecast=0;featurePlanEstimate&&(plan=100*(featureNbDaysElapseToDate*featurePlanEstimatePerDay/featurePlanEstimate),actual=100*(featureActualEstimate/featurePlanEstimate),forecast=100*((featurePlanEstimate-featureActualEstimate)/featureActualEstimatePerDay)+actual),actualData.push(actual),expectedData.push(plan),forecastData.push(forecast)}),{categories:categories,series:[{name:"Actual",data:actualData},{name:"Expected",data:expectedData}]}}});
                Ext.define("Yahoo.app.FeatureCompleteness",{extend:"Rally.app.TimeboxScopedApp",requires:["Yahoo.app.FeatureCompletenessCalculator"],componentCls:"app",scopeType:"release",addContent:function(scope){this._drawChart()},onScopeChange:function(scope){this._drawChart()},_drawChart:function(){this.chart&&this.chart.destroy(),this.chart=this.add({xtype:"rallychart",storeType:"Rally.data.WsapiDataStore",storeConfig:{model:"PortfolioItemFeature",context:this.getContext().getDataContext(),filters:[this.getContext().getTimeboxScope().getQueryFilter()],sorters:[{property:"Rank",direction:"DESC"}],pageSize:50,fetch:["PlannedStartDate","PlannedEndDate","LeafStoryPlanEstimateTotal","AcceptedLeafStoryPlanEstimateTotal","Name","Release","ReleaseDate","ReleaseStartDate"]},calculatorType:"Yahoo.app.FeatureCompletenessCalculator",calculatorConfig:{},chartConfig:this._getChartConfig()})},_getChartConfig:function(){return{chart:{type:"bar"},title:{text:"PSI Completeness Report"},xAxis:{title:{text:null}},yAxis:{min:0,max:100,title:{text:"% Complete",align:"high"},labels:{overflow:"justify"}},tooltip:{valueSuffix:" %"},plotOptions:{bar:{dataLabels:{enabled:!1}}},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:-100,y:100,floating:!0,borderWidth:1,backgroundColor:"#FFFFFF",shadow:!0,reversed:!0}}}});

            Rally.launchApp('Yahoo.app.FeatureCompleteness', {
                name:"Feature Completeness Report",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
